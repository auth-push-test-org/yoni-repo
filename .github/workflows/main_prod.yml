name: Build, Push, and Scan Prod

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read      # ‚Üê important for GET /actions/runs/{run_id}

jobs:
  build-and-scan:
    runs-on: ubuntu-latest

    # Static/env values that aren't secrets
    env:
      DOCKER_REGISTRY: e2ecrdev.azurecr.io
      IMAGE_NAME: yoni_newcli_eus2_new_github_image
      IMAGE_TARGET: e2ecrdev.azurecr.io/red/yoni_newcli_eus2_new_github_image
      DfdBackendServiceEnvironmentt: PPE
      GDN_NUGET_SOURCE_FEED_OVERRIDE: https://pkgs.dev.azure.com/msdoustest/msdo/_packaging/msdotestfeed2/nuget/v3/index.json
      GITHUB_REPOSITORY_OWNER_ID: ""
      GITHUB_REPOSITORY_ID: ""

      # Helpful on minimal distros if the Defender CLI needs it; harmless on Ubuntu
      DOTNET_SYSTEM_GLOBALIZATION_INVARIANT: "1"

    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4

      - name: Log in to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build, tag, and push image
        run: |
          echo "Building Docker image..."
          docker build -t "${IMAGE_NAME}" .

          echo "Tagging..."
          docker tag "${IMAGE_NAME}" "${IMAGE_TARGET}:V${{ github.run_number }}"
          docker tag "${IMAGE_NAME}" "${IMAGE_TARGET}:latest"

      - name: Download Defender CLI
        run: |
          echo "Downloading Defender CLI..."
          curl -L -o defender "https://cli.dfd.security.stage.azure-test.net/public/latest/Defender_linux-x64"
          chmod +x defender

      # Jenkins wiped specific workspace folders; here we mirror that safely within the Actions workspace.
      - name: Clean workspace artifacts (optional)
        run: |
          rm -rf "$GITHUB_WORKSPACE/Config" "$GITHUB_WORKSPACE/.gdn" || true

      - name: Scan image with Defender CLI
        env:
          # Defender CLI auth/tenant values from Secrets
          GDN_MDC_CLI_CLIENT_ID: ${{ secrets.GDN_MDC_CLI_CLIENT_ID }}
          GDN_MDC_CLI_TENANT_ID: ${{ secrets.GDN_MDC_CLI_TENANT_ID }}
          GDN_MDC_CLI_CLIENT_SECRET: ${{ secrets.GDN_MDC_CLI_CLIENT_SECRET }}
        run: |
          echo "Ensuring ACR login is valid for scan pull..."
          docker login "${DOCKER_REGISTRY}" \
            --username "${{ secrets.DOCKER_USERNAME }}" \
            --password "${{ secrets.DOCKER_PASSWORD }}"

          echo "Running Defender scan..."
          unset GITHUB_REPOSITORY_OWNER_ID 
          unset GITHUB_REPOSITORY_ID
          ./defender scan image "${IMAGE_TARGET}" --update-configs --scanner mdvm --mdvm-output defender-output.sarif
          ls .

      - name: Upload SARIF to Code Scanning
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        with:
          sarif_file: defender.sarif

          
